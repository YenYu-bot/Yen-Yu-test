<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>進階拖曳式排課系統</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      margin: 0;
    }
    .task-inputs {
      margin-bottom: 20px;
    }
    .task {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 5px;
      margin: 5px;
      cursor: grab;
      color: #fff;
      font-weight: bold;
      position: relative;
    }
    .task[draggable="true"]:hover {
      opacity: 0.8;
    }
    .editable {
      border: none;
      background: transparent;
      font-weight: bold;
      color: inherit;
    }
    .schedule-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 5px;
    }
    .time-slot {
      border: 1px solid #ccc;
      min-height: 120px;
      padding: 2px;
      position: relative;
    }
    .label {
      font-size: 12px;
      font-weight: bold;
    }
    .cell-inner {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, 1fr);
      height: 100%;
      gap: 2px;
    }
    .cell-box {
      border: 1px dashed #999;
      position: relative;
    }
    .animate-success {
      animation: zoomFlash 1s ease-in-out;
    }
    .animate-fail {
      animation: bounceAway 0.8s ease-in-out;
    }
    @keyframes zoomFlash {
      0% { transform: scale(1); background-color: yellow; }
      50% { transform: scale(1.2); background-color: lime; }
      100% { transform: scale(1); background-color: inherit; }
    }
    @keyframes bounceAway {
      0% { transform: translateY(0); }
      25% { transform: translateY(-10px); }
      50% { transform: translateX(20px); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }
  </style>
</head>
<body>
  <h1>進階拖曳式排課系統</h1>
  <div class="task-inputs">
    <label>班級名稱：<input type="text" id="className" /></label>
    <label>老師代號：<input type="text" id="teacherCode" /></label>
    <button onclick="addClassTask()">新增課程方塊</button>
  </div>
  <div id="task-bank"></div>

  <h2>週課表（0900-2130）</h2>
  <div class="schedule-grid" id="schedule"></div>

  <h2>老師課表一覽</h2>
  <pre id="teacherSchedules"></pre>

  <script>
    const taskBank = document.getElementById('task-bank');
    const schedule = document.getElementById('schedule');
    const teacherSchedules = {};
    let taskId = 0;
    const colors = Array.from({length: 30}, (_, i) => `hsl(${i * 12}, 70%, 60%)`);

    const timeBlocks = [
      "0900-1030", "1030-1200", "1200-1330(午餐)", "1330-1500",
      "1500-1630", "1630-1800", "1800-1830(晚餐)", "1830-2000", "2000-2130"
    ];
    const days = ["星期一", "星期二", "星期三", "星期四", "星期五", "星期六"];
    const boxLabels = ["2小", "3後", "4前", "4後"];

    function generateScheduleGrid() {
      for (let t = 0; t < timeBlocks.length; t++) {
        for (let d = 0; d < days.length; d++) {
          const slot = document.createElement('div');
          slot.className = 'time-slot';
          const label = document.createElement('div');
          label.className = 'label';
          label.textContent = `${days[d]} ${timeBlocks[t]}`;
          slot.appendChild(label);

          const inner = document.createElement('div');
          inner.className = 'cell-inner';
          boxLabels.forEach(bl => {
            const cell = document.createElement('div');
            cell.className = 'cell-box';
            cell.setAttribute('data-day', days[d]);
            cell.setAttribute('data-time', timeBlocks[t]);
            cell.setAttribute('data-label', bl);
            cell.ondragover = ev => ev.preventDefault();
            cell.ondrop = dropTask;
            inner.appendChild(cell);
          });
          slot.appendChild(inner);
          schedule.appendChild(slot);
        }
      }
    }

    function addClassTask() {
      const name = document.getElementById('className').value.trim();
      const code = document.getElementById('teacherCode').value.trim();
      if (!name || !code || document.querySelectorAll('.task').length >= 30) return;

      const task = document.createElement('div');
      task.className = 'task';
      task.draggable = true;
      task.style.backgroundColor = colors[taskId % 30];
      task.setAttribute('data-code', code);
      task.setAttribute('data-usage', '0');
      task.id = `task-${taskId++}`;
      task.ondragstart = drag;

      const editable = document.createElement('input');
      editable.className = 'editable';
      editable.value = name;
      editable.onchange = () => updateDisplay();
      task.appendChild(editable);
      taskBank.appendChild(task);
    }

    function drag(ev) {
      ev.dataTransfer.setData("text", ev.target.id);
    }

    function dropTask(ev) {
      ev.preventDefault();
      const id = ev.dataTransfer.getData("text");
      const task = document.getElementById(id);
      const teacher = task.getAttribute('data-code');
      const day = ev.target.getAttribute('data-day');
      const time = ev.target.getAttribute('data-time');
      const label = ev.target.getAttribute('data-label');

      // 檢查老師重複
      const allBoxes = document.querySelectorAll(`[data-day='${day}'][data-time='${time}']`);
      for (const box of allBoxes) {
        if (box.contains(task)) continue;
        const t = box.querySelector('.task');
        if (t && t.getAttribute('data-code') === teacher) {
          task.classList.add('animate-fail');
          setTimeout(() => task.classList.remove('animate-fail'), 800);
          return;
        }
      }

      ev.target.appendChild(task);
      task.classList.add('animate-success');
      setTimeout(() => task.classList.remove('animate-success'), 1000);

      let usage = parseInt(task.getAttribute('data-usage')) + 1;
      task.setAttribute('data-usage', usage);
      if (usage >= 2) task.style.display = 'none';

      // 更新老師課表
      if (!teacherSchedules[teacher]) teacherSchedules[teacher] = [];
      teacherSchedules[teacher].push(`${day} ${time} ${label}：${task.textContent}`);
      updateDisplay();
    }

    function updateDisplay() {
      const out = [];
      for (const [teacher, list] of Object.entries(teacherSchedules)) {
        out.push(`老師 ${teacher}：\n` + list.join("\n"));
      }
      document.getElementById('teacherSchedules').textContent = out.join("\n\n");
    }

    generateScheduleGrid();
  </script>
</body>
</html>
