ease-in-out;
    }
    @keyframes zoomFlash {
      0% { transform: scale(1); background-color: yellow; }
      50% { transform: scale(1.2); background-color: lime; }
      100% { transform: scale(1); background-color: inherit; }
    }
    @keyframes bounceAway {
      0% { transform: translateY(0); }
      25% { transform: translateY(-10px); }
      50% { transform: translateX(20px); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }
    .control-buttons {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    #teacherSchedules {
      background-color: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>進階拖曳式排課系統</h1>
  <div class="task-inputs">
    <label>課程名稱：<input type="text" id="className" /></label>
    <label>老師代號：<input type="text" id="teacherCode" /></label>
    <button onclick="addClassTask()">新增課程方塊</button>
  </div>
  <div id="task-bank"></div>

  <h2>週課表（0900-2130）</h2>
  <div class="schedule-grid" id="schedule"></div>

  <h2>老師課表一覽</h2>
  <pre id="teacherSchedules"></pre>

  <div class="control-buttons">
    <button onclick="saveSchedule()">💾 儲存排程</button>
    <button onclick="loadSchedule()">📂 載入排程</button>
    <button onclick="downloadSchedule()">⬇️ 下載課表</button>
    <button onclick="copySchedule()">📋 複製課表</button>
  </div>

  <script>
    const taskBank = document.getElementById('task-bank');
    const schedule = document.getElementById('schedule');
    const teacherSchedules = {};
    const taskUsageCount = {};
    const taskInfoMap = {};
    let taskId = 0;
    const colors = Array.from({length: 30}, (_, i) => `hsl(${i * 12}, 70%, 60%)`);

    const timeBlocks = [
      "0900-1030", "1030-1200", "1200-1330(午餐)", "1330-1500",
      "1500-1630", "1630-1800", "1800-1830(晚餐)", "1830-2000", "2000-2130"
    ];
    const days = ["星期一", "星期二", "星期三", "星期四", "星期五", "星期六"];
    const boxLabels = ["2小", "3後", "4前", "4後"];

    function generateScheduleGrid() {
      for (let t = 0; t < timeBlocks.length; t++) {
        for (let d = 0; d < days.length; d++) {
          const slot = document.createElement('div');
          slot.className = 'time-slot';
          const label = document.createElement('div');
          label.className = 'label';
          label.textContent = `${days[d]} ${timeBlocks[t]}`;
          slot.appendChild(label);

          const inner = document.createElement('div');
          inner.className = 'cell-inner';
          boxLabels.forEach(bl => {
            const cell = document.createElement('div');
            cell.className = 'cell-box';
            cell.setAttribute('data-day', days[d]);
            cell.setAttribute('data-time', timeBlocks[t]);
            cell.setAttribute('data-label', bl);
            cell.ondragover = ev => ev.preventDefault();
            cell.ondrop = dropTask;
            inner.appendChild(cell);
          });
          slot.appendChild(inner);
          schedule.appendChild(slot);
        }
      }
    }

    function addClassTask() {
      const name = document.getElementById('className').value.trim();
      const code = document.getElementById('teacherCode').value.trim();
      if (!name || !code || document.querySelectorAll('.task').length >= 30) return;

      const task = document.createElement('div');
      task.className = 'task';
      task.draggable = true;
      task.style.backgroundColor = colors[taskId % 30];
      task.setAttribute('data-code', code);
      task.setAttribute('data-name', name);
      task.id = `task-${taskId}`;
      taskUsageCount[task.id] = 0;
      taskInfoMap[task.id] = { name, code };
      task.ondragstart = drag;

      const editable = document.createElement('input');
      editable.className = 'editable';
      editable.value = name;
      editable.onchange = () => updateDisplay();
      task.appendChild(editable);
      taskBank.appendChild(task);
      taskId++;
    }

    function drag(ev) {
      ev.dataTransfer.setData("text", ev.target.id);
    }

    function dropTask(ev) {
      ev.preventDefault();
      const id = ev.dataTransfer.getData("text");
      const task = document.getElementById(id);
      const { code, name } = taskInfoMap[id] || {};
      const day = ev.target.getAttribute('data-day');
      const time = ev.target.getAttribute('data-time');
      const label = ev.target.getAttribute('data-label');

      const allBoxes = document.querySelectorAll(`[data-day='${day}'][data-time='${time}']`);
      for (const box of allBoxes) {
        if (box.contains(task)) continue;
        const t = box.querySelector('.task');
        if (t && t.getAttribute('data-code') === code) {
          task.classList.add('animate-fail');
          setTimeout(() => task.classList.remove('animate-fail'), 800);
          return;
        }
      }

      ev.target.appendChild(task);
      task.classList.add('animate-success');
      setTimeout(() => task.classList.remove('animate-success'), 1000);

      taskUsageCount[id] = (taskUsageCount[id] || 0) + 1;
      if (taskUsageCount[id] >= 2) {
        task.style.display = 'none';
      }

      if (!teacherSchedules[code]) teacherSchedules[code] = [];
      teacherSchedules[code].push(`${day} ${time} ${label}：${name}`);
      task.innerHTML = `<span>${code}</span>`;
      task.setAttribute('data-name', name);
      task.setAttribute('data-code', code);
      updateDisplay();
    }

    function updateDisplay() {
      const out = [];
      for (const [teacher, list] of Object.entries(teacherSchedules)) {
        out.push(`老師 ${teacher}：\n` + list.join("\n"));
      }
      document.getElementById('teacherSchedules').textContent = out.join("\n\n");
    }

    function saveSchedule() {
      localStorage.setItem('taskBank', taskBank.innerHTML);
      localStorage.setItem('schedule', schedule.innerHTML);
      localStorage.setItem('teacherSchedules', JSON.stringify(teacherSchedules));
      alert('課表已儲存！');
    }

    function loadSchedule() {
      if (localStorage.getItem('taskBank')) {
        taskBank.innerHTML = localStorage.getItem('taskBank');
        schedule.innerHTML = localStorage.getItem('schedule');
        Object.assign(teacherSchedules, JSON.parse(localStorage.getItem('teacherSchedules')));
        document.querySelectorAll('.task').forEach(task => {
          task.ondragstart = drag;
        });
        document.querySelectorAll('.cell-box').forEach(cell => {
          cell.ondrop = dropTask;
          cell.ondragover = ev => ev.preventDefault();
        });
        updateDisplay();
        alert('課表已載入！');
      } else {
        alert('尚未儲存過課表');
      }
    }

    function downloadSchedule() {
      const text = document.getElementById('teacherSchedules').textContent;
      const blob = new Blob([text], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'teacher_schedule.txt';
      link.click();
    }

    function copySchedule() {
      navigator.clipboard.writeText(document.getElementById('teacherSchedules').textContent)
        .then(() => alert('課表已複製到剪貼簿'))
        .catch(err => alert('複製失敗: ' + err));
    }

    document.addEventListener('DOMContentLoaded', generateScheduleGrid);
  </script>
</body>
</html>
