<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>拖曳式排課系統</title>
  <style>
    /* 文字方塊基礎樣式 */
    .course-box {
      display: inline-block;
      padding: 8px 12px;
      margin: 4px;
      border-radius: 4px;
      cursor: grab;
      user-select: none;
      transition: transform 0.2s ease;
    }

    /* 成功放置動畫 */
    .anim-success {
      animation: success-scale 0.4s ease forwards;
    }
    @keyframes success-scale {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    @keyframes flash {
      0%,100% { opacity: 1; }
      50% { opacity: 0.2; }
    }
    .anim-flash {
      animation: flash 0.5s ease;
    }

    /* 失敗放置動畫 */
    .anim-fail {
      animation: shake 0.5s ease;
    }
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      20%,60% { transform: translateX(-5px); }
      40%,80% { transform: translateX(5px); }
    }

    /* 排課表格樣式 */
    .timetable { border-collapse: collapse; width: 100%; }
    .timetable td, .timetable th { border: 1px solid #ccc; width: calc(100%/7); height: 60px; position: relative; }
    .timetable .rest { background: #f9f9f9; }

    /* 隱藏時間段開關按鈕 */
    .toggle-btn { margin: 0 4px; padding: 4px 8px; cursor: pointer; }
  </style>
</head>
<body>
  <!-- 輸入區 -->
  <div id="input-area">
    <input id="className" placeholder="班級名稱" />
    <input id="teacherCode" placeholder="教師代號" />
    <button id="addBoxBtn">新增文字方塊</button>
  </div>
  <div id="boxes-area"></div>

  <!-- 時間段切換開關 -->
  <div id="segment-toggles"></div>

  <!-- 周表 -->
  <table class="timetable" id="timetable">
    <thead><tr><th>時段 / 星期</th><th>一</th><th>二</th><th>三</th><th>四</th><th>五</th><th>六</th></tr></thead>
    <tbody id="timetable-body"></tbody>
  </table>

  <!-- 老師個人課表 -->
  <div id="personal-schedules"></div>

  <!-- 操作按鈕 -->
  <button id="saveBtn">儲存</button>
  <button id="downloadBtn">下載課表</button>
  <button id="copyBtn">複製課表</button>

  <script>
    // 常數設定
    const MAX_BOXES = 30;
    const MAX_USES = 2;
    const timeSlots = [
      '09:00-10:30','10:30-12:00','12:00-13:30','13:30-15:00','15:00-16:30','16:30-18:00','18:00-19:30','19:30-21:00'
    ];
    const days = ['一','二','三','四','五','六'];

    // 初始化
    document.getElementById('addBoxBtn').addEventListener('click', addCourseBox);
    document.getElementById('saveBtn').addEventListener('click', saveState);
    document.getElementById('downloadBtn').addEventListener('click', downloadSchedule);
    document.getElementById('copyBtn').addEventListener('click', copySchedule);
    buildTimetable();
    loadState();

    // 建立排課格
    function buildTimetable() {
      const tbody = document.getElementById('timetable-body');
      timeSlots.forEach((slot, rowIdx) => {
        const tr = document.createElement('tr');
        const th = document.createElement('th'); th.textContent = slot; tr.appendChild(th);
        days.forEach((day, colIdx) => {
          const td = document.createElement('td');
          td.dataset.slot = slot;
          td.dataset.day = day;
          td.addEventListener('dragover', e => e.preventDefault());
          td.addEventListener('drop', handleDrop);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      buildToggles();
    }

    // 建立時間段隱藏開關
    function buildToggles() {
      const container = document.getElementById('segment-toggles');
      timeSlots.forEach(slot => {
        const btn = document.createElement('button');
        btn.textContent = slot;
        btn.className = 'toggle-btn';
        btn.dataset.slot = slot;
        btn.addEventListener('click', toggleSlotVisibility);
        container.appendChild(btn);
      });
    }

    function toggleSlotVisibility(e) {
      const slot = e.target.dataset.slot;
      document.querySelectorAll(`td[data-slot='${slot}']`).forEach(td => {
        td.style.display = td.style.display === 'none' ? '' : 'none';
      });
    }

    // 新增文字方塊
    function addCourseBox() {
      const name = document.getElementById('className').value.trim();
      const code = document.getElementById('teacherCode').value.trim();
      if (!name || !code) return;
      const count = document.querySelectorAll('#boxes-area .course-box').length;
      if (count >= MAX_BOXES) return alert('文字方塊已達上限');
      const box = document.createElement('div');
      box.className = 'course-box';
      box.draggable = true;
      box.textContent = `${name} (${code})`;
      box.dataset.uses = 0;
      box.style.background = randomColor();
      box.addEventListener('dragstart', handleDragStart);
      box.addEventListener('dragend', handleDragEnd);

      // 右鍵功能：編輯與刪除
      box.addEventListener('contextmenu', e => {
        e.preventDefault();
        const newCode = prompt('輸入新的教師代號', code);
        if (newCode !== null) box.textContent = `${name} (${newCode})`;
      });
      container = document.getElementById('boxes-area');
      container.appendChild(box);
    }

    let draggedBox = null;
    function handleDragStart(e) {
      draggedBox = e.target;
      e.dataTransfer.setData('text/plain', null);
    }
    function handleDrop(e) {
      e.preventDefault();
      const td = e.target;
      const slot = td.dataset.slot;
      const day = td.dataset.day;
      // 限制同老師同時段
      if ([...td.children].some(child => child.textContent.includes(extractCode(draggedBox.textContent)))) {
        animateFail(draggedBox);
        return;
      }
      td.appendChild(draggedBox);
      animateSuccess(draggedBox);
      incrementUse(draggedBox);
    }
    function handleDragEnd(e) {
      // 空實現
    }

    function extractCode(text) {
      return text.match(/\(([^)]+)\)$/)[1];
    }
    function animateSuccess(box) {
      box.classList.add('anim-success','anim-flash');
      setTimeout(() => box.classList.remove('anim-success','anim-flash'), 500);
    }
    function animateFail(box) {
      box.classList.add('anim-fail');
      setTimeout(() => box.classList.remove('anim-fail'), 500);
    }

    function incrementUse(box) {
      let uses = parseInt(box.dataset.uses) + 1;
      box.dataset.uses = uses;
      if (uses >= MAX_USES) box.style.display = 'none';
    }

    /* 存取本地狀態 */
    function saveState() {
      const data = {
        boxes: [...document.querySelectorAll('.course-box')].map(b => ({ text: b.textContent, uses: b.dataset.uses, hidden: b.style.display === 'none' })),
        placements: [...document.querySelectorAll('td')].flatMap(td => [...td.children].map(b => ({ day: td.dataset.day, slot: td.dataset.slot, text: b.textContent })))
      };
      localStorage.setItem('scheduleData', JSON.stringify(data));
      alert('已儲存');
    }
    function loadState() {
      const raw = localStorage.getItem('scheduleData');
      if (!raw) return;
      const data = JSON.parse(raw);
      // 待自行補充：還原boxes與placements
    }

    function downloadSchedule() {
      const blob = new Blob([localStorage.getItem('scheduleData') || ''], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'schedule.json';
      a.click();
      URL.revokeObjectURL(url);
    }
    function copySchedule() {
      navigator.clipboard.writeText(localStorage.getItem('scheduleData') || '');
      alert('已複製');
    }

    function randomColor() {
      return `hsl(${Math.random()*360},50%,75%)`;
    }
  </script>
</body>
</html>
